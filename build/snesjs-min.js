//SNESJS by simplyianm
SNESJS=function(){this.cpu=new SNESJS.CPU(this);this.bus=new SNESJS.Bus(this)}var PORT_1=0;var PORT_2=1;var DEVICE_NONE=0;var DEVICE_JOYPAD=1;var DEVICE_MULTITAP=2;var DEVICE_MOUSE=3;var DEVICE_SUPERSCOPE=4;var DEVICE_JUSTIFIER=5;var DEVICE_JUSTIFIERS=6;var JOYPAD_B=1<<0;var JOYPAD_Y=1<<1;var JOYPAD_SELECT=1<<2;var JOYPAD_START=1<<3;var JOYPAD_UP=1<<4;var JOYPAD_DOWN=1<<5;var JOYPAD_LEFT=1<<6;var JOYPAD_RIGHT=1<<7;var JOYPAD_A=1<<8;var JOYPAD_X=1<<9;var JOYPAD_L=1<<10;var JOYPAD_R=1<<11;var MOUSE_X=1<<0;var MOUSE_Y=1<<1;var MOUSE_LEFT=1<<2;var MOUSE_RIGHT=1<<3;var SUPERSCOPE_X=1<<0;var SUPERSCOPE_Y=1<<1;var SUPERSCOPE_TRIGGER=1<<2;var SUPERSCOPE_CURSOR=1<<3;var SUPERSCOPE_TURBO=1<<4;var SUPERSCOPE_PAUSE=1<<5;var JUSTIFIER_X=1<<0;var JUSTIFIER_Y=1<<1;var JUSTIFIER_TRIGGER=1<<2;var JUSTIFIER_START=1<<3;var REGION_NTSC=0;var REGION_PAL=1;var MEMORYTYPE_RAM=0;var MEMORYTYPE_RTC=1;var MEMORYTYPE_BSXRAM=2;var MEMORYTYPE_BSXPRAM=3;var MEMORYTYPE_SUFAMITURBOARAM=4;var MEMORYTYPE_SUFAMITURBOBRAM=5;var MEMORYTYPE_GAMEBOYRAM=6;var MEMORYTYPE_GAMEBOYRTC=7;var TBL_EM=0;var TBL_MX=256;var TBL_Mx=512;var TBL_mX=768;var TBL_mx=1024;var OPCODE_A=0;var OPCODE_X=1;var OPCODE_Y=2;var OPCODE_Z=3;var OPCODE_S=4;var OPCODE_D=5;SNESJS.CPU=function(a){this.snes=a;this.alu=new SNESJS.CPU.ALU();this.regs=new SNESJS.CPU.Regs();this.aa=new SNESJS.CPU.Reg24();this.rd=new SNESJS.CPU.Reg24();this.sp=0;this.dp=0;this._5=0;this.channel=[new SNESJS.CPU.Channel(),new SNESJS.CPU.Channel(),new SNESJS.CPU.Channel(),new SNESJS.CPU.Channel(),new SNESJS.CPU.Channel(),new SNESJS.CPU.Channel(),new SNESJS.CPU.Channel(),new SNESJS.CPU.Channel()];this.port_data=[0,0,0,0];this.status=new SNESJS.CPU.Status();this.initialize_opcode_table()}SNESJS.CPU.prototype.step=function(a){this.snes.smp.clock-=a*this.snes.smp.frequency;this.snes.ppu.clock-=a;for(var b=0;b<snes.coprocessors.length;b++){var c=coprocessors[b];c.clock-=a*c.frequency}}SNESJS.CPU.prototype.synchronize_smp=function(){while(this.snes.smp.clock<0){this.snes.smp.enter()}}SNESJS.CPU.prototype.synchronize_ppu=function(){while(this.snes.ppu.clock<0){this.snes.ppu.enter()}}SNESJS.CPU.prototype.synchronize_coprocessors=function(){for(var a=0;a<this.coprocessors.length;a++){var b=this.coprocessors[a];if(b.clock<0){}}}SNESJS.CPU.prototype.synchronize_controllers=function(){}SNESJS.CPU.prototype.op_io=function(){this.add_clocks(6)}SNESJS.CPU.prototype.enter=function(){while(true){if(this.status.nmi_pending){this.status.nmi_pending=false;this.regs.vector=(this.regs.e==false?0xffee:0xfffe);this.op_irq()}if(this.status.irq_pending){this.status.irq_pending=false;this.regs.vector=(this.regs.e==false?0xffee:0xfffe);this.op_irq()}this.op_step()}}SNESJS.CPU.prototype.op_step=function(){this.optable[this.op_readpc()]()}SNESJS.CPU.prototype.cpu_wram_reader=function(a){return this.wram[a]}SNESJS.CPU.prototype.cpu_wram_writer=function(a,b){this.cpu.wram[a]=b}SNESJS.CPU.prototype.enable=function(){}SNESJS.CPU.prototype.power=function(){this.regs.a=0x0000;this.regs.x=0x0000;this.regs.y=0x0000;this.regs.s=0x01ff;this.reset()}SNESJS.CPU.prototype.reset=function(){this.snes.processor.create(Enter,this.snes.system.cpu_frequency);this.snes.coprocessors.reset();this.snes.ppucounter.reset();this.regs.pc.d=0x000000;this.regs.x.h=0x00;this.regs.y.h=0x00;this.regs.s.h=0x01;this.regs.d.w=0x0000;this.regs.db=0x00;this.regs.p.assign(0x34);this.regs.e=1;this.regs.mdr=0x00;this.regs.wai=false;update_table();this.regs.pc.l=this.snes.bus.read(0xfffc);this.regs.pc.h=this.snes.bus.read(0xfffd);this.regs.pc.b=0x00;this.status.nmi_valid=false;this.status.nmi_line=false;this.status.nmi_transition=false;this.status.nmi_pending=false;this.status.irq_valid=false;this.status.irq_line=false;this.status.irq_transition=false;this.status.irq_pending=false;this.status.irq_lock=false;this.status.hdma_pending=false;this.status.wram_addr=0x000000;this.status.joypad_strobe_latch=0;this.status.nmi_enabled=false;this.status.virq_enabled=false;this.status.hirq_enabled=false;this.status.auto_joypad_poll_enabled=false;this.status.pio=0xff;this.status.htime=0x0000;this.status.vtime=0x0000;this.status.rom_speed=8;this.status.joy1l=this.status.joy1h=0x00;this.status.joy2l=this.status.joy2h=0x00;this.status.joy3l=this.status.joy3h=0x00;this.status.joy4l=this.status.joy4h=0x00;this.dma_reset()}SNESJS.CPU.ALU=function(){this.mpyctr=0;this.divctr=0;this.shift=0}SNESJS.CPU.Channel=function(){this.dma_enabled=false;this.hdma_enabled=false;this.direction=false;this.indirect=false;this.unused=false;this.reverse_transfer=false;this.fixed_transfer=false;this.transfer_mode=0;this.dest_addr=0;this.source_addr=0;this.source_bank=0;this.union=new SNESJS.CPU.Channel.Union();this.indirect_bank=0;this.hdma_addr=0;this.line_counter=0;this.unknown=0;this.hdma_completed=false;this.hdma_do_transfer=false}SNESJS.CPU.Channel.Union=function(){this.transfer_size=0;this.indirect_addr=0}SNESJS.CPU.prototype.op_io_irq=function(){if(interrupt_pending()){this.op_read(this.regs.pc.d)}else{this.op_io()}}SNESJS.CPU.prototype.op_io_cond2=function(){if(this.regs.d.l!=0x00){this.op_io()}}SNESJS.CPU.prototype.op_io_cond4=function(a,b){if(!this.regs.p.x||(a&0xff00)!=(b&0xff00)){this.op_io()}}SNESJS.CPU.prototype.op_io_cond6=function(a){if(this.regs.e&&(this.regs.pc.w&0xff00)!=(a&0xff00)){this.op_io()}}SNESJS.CPU.prototype.op_irq=function(){this.op_read(this.regs.pc.d);this.op_io();if(!this.regs.e){this.op_writestack(this.regs.pc.b)}this.op_writestack(this.regs.pc.h);this.op_writestack(this.regs.pc.l);this.op_writestack(this.regs.e?(this.regs.p&~0x10):this.regs.p);this.rd.l=this.op_read(this.regs.vector+0);this.regs.pc.b=0x00;this.regs.p.i=1;this.regs.p.d=0;this.rd.h=this.op_read(this.regs.vector+1);this.regs.pc.w=this.rd.w}SNESJS.CPU.prototype.opcode_length=function(){var a,b;a=this.dreadb(this.regs.pc.d);b=SNESJS.CPU.OPS._4[a];if(b==5){return(this.regs.e||this.regs.p.m)?2:3}if(b==6){return(this.regs.e||this.regs.p.x)?2:3}return b}SNESJS.CPU.prototype.initialize_opcode_table=function(){this.opEII(0x00,"interrupt",0xfffe,0xffe6);this.opMF(0x01,"read_idpx","ora");this.opEII(0x02,"interrupt",0xfff4,0xffe4);this.opMF(0x03,"read_sr","ora");this.opMF(0x04,"adjust_dp","tsb");this.opMF(0x05,"read_dp","ora");this.opMF(0x06,"adjust_dp","asl");this.opMF(0x07,"read_ildp","ora");this.opA(0x08,"php");this.opMF(0x09,"read_const","ora");this.opM(0x0a,"asl_imm");this.opE(0x0b,"phd");this.opMF(0x0c,"adjust_addr","tsb");this.opMF(0x0d,"read_addr","ora");this.opMF(0x0e,"adjust_addr","asl");this.opMF(0x0f,"read_long","ora");this.opAII(0x10,"branch",0x80,0x00);this.opMF(0x11,"read_idpy","ora");this.opMF(0x12,"read_idp","ora");this.opMF(0x13,"read_isry","ora");this.opMF(0x14,"adjust_dp","trb");this.opMFI(0x15,"read_dpr","ora",OPCODE_X);this.opMF(0x16,"adjust_dpx","asl");this.opMF(0x17,"read_ildpy","ora");this.opAII(0x18,"flag",0x01,0x00);this.opMF(0x19,"read_addry","ora");this.opMII(0x1a,"adjust_imm",OPCODE_A,1);this.opE(0x1b,"tcs");this.opMF(0x1c,"adjust_addr","trb");this.opMF(0x1d,"read_addrx","ora");this.opMF(0x1e,"adjust_addrx","asl");this.opMF(0x1f,"read_longx","ora");this.opA(0x20,"jsr_addr");this.opMF(0x21,"read_idpx","and");this.opE(0x22,"jsr_long");this.opMF(0x23,"read_sr","and");this.opMF(0x24,"read_dp","bit");this.opMF(0x25,"read_dp","and");this.opMF(0x26,"adjust_dp","rol");this.opMF(0x27,"read_ildp","and");this.opE(0x28,"plp");this.opMF(0x29,"read_const","and");this.opM(0x2a,"rol_imm");this.opE(0x2b,"pld");this.opMF(0x2c,"read_addr","bit");this.opMF(0x2d,"read_addr","and");this.opMF(0x2e,"adjust_addr","rol");this.opMF(0x2f,"read_long","and");this.opAII(0x30,"branch",0x80,1);this.opMF(0x31,"read_idpy","and");this.opMF(0x32,"read_idp","and");this.opMF(0x33,"read_isry","and");this.opMFI(0x34,"read_dpr","bit",OPCODE_X);this.opMFI(0x35,"read_dpr","and",OPCODE_X);this.opMF(0x36,"adjust_dpx","rol");this.opMF(0x37,"read_ildpy","and");this.opAII(0x38,"flag",0x01,0x01);this.opMF(0x39,"read_addry","and");this.opMII(0x3a,"adjust_imm",OPCODE_A,-1);this.opAII(0x3b,"transfer_w",OPCODE_S,OPCODE_A);this.opMF(0x3c,"read_addrx","bit");this.opMF(0x3d,"read_addrx","and");this.opMF(0x3e,"adjust_addrx","rol");this.opMF(0x3f,"read_longx","and");this.opE(0x40,"rti");this.opMF(0x41,"read_idpx","eor");this.opA(0x42,"wdm");this.opMF(0x43,"read_sr","eor");this.opXI(0x44,"move",-1);this.opMF(0x45,"read_dp","eor");this.opMF(0x46,"adjust_dp","lsr");this.opMF(0x47,"read_ildp","eor");this.opMI(0x48,"push",OPCODE_A);this.opMF(0x49,"read_const","eor");this.opM(0x4a,"lsr_imm");this.opA(0x4b,"phk");this.opA(0x4c,"jmp_addr");this.opMF(0x4d,"read_addr","eor");this.opMF(0x4e,"adjust_addr","lsr");this.opMF(0x4f,"read_long","eor");this.opAII(0x50,"branch",0x40,0);this.opMF(0x51,"read_idpy","eor");this.opMF(0x52,"read_idp","eor");this.opMF(0x53,"read_isry","eor");this.opXI(0x54,"move",+1);this.opMFI(0x55,"read_dpr","eor",OPCODE_X);this.opMF(0x56,"adjust_dpx","lsr");this.opMF(0x57,"read_ildpy","eor");this.opAII(0x58,"flag",0x04,0x00);this.opMF(0x59,"read_addry","eor");this.opXI(0x5a,"push",OPCODE_Y);this.opAII(0x5b,"transfer_w",OPCODE_A,OPCODE_D);this.opA(0x5c,"jmp_long");this.opMF(0x5d,"read_addrx","eor");this.opMF(0x5e,"adjust_addrx","lsr");this.opMF(0x5f,"read_longx","eor");this.opA(0x60,"rts");this.opMF(0x61,"read_idpx","adc");this.opE(0x62,"per");this.opMF(0x63,"read_sr","adc");this.opMI(0x64,"write_dp",OPCODE_Z);this.opMF(0x65,"read_dp","adc");this.opMF(0x66,"adjust_dp","ror");this.opMF(0x67,"read_ildp","adc");this.opMI(0x68,"pull",OPCODE_A);this.opMF(0x69,"read_const","adc");this.opM(0x6a,"ror_imm");this.opE(0x6b,"rtl");this.opA(0x6c,"jmp_iaddr");this.opMF(0x6d,"read_addr","adc");this.opMF(0x6e,"adjust_addr","ror");this.opMF(0x6f,"read_long","adc");this.opAII(0x70,"branch",0x40,1);this.opMF(0x71,"read_idpy","adc");this.opMF(0x72,"read_idp","adc");this.opMF(0x73,"read_isry","adc");this.opMII(0x74,"write_dpr",OPCODE_Z,OPCODE_X);this.opMFI(0x75,"read_dpr","adc",OPCODE_X);this.opMF(0x76,"adjust_dpx","ror");this.opMF(0x77,"read_ildpy","adc");this.opAII(0x78,"flag",0x04,0x04);this.opMF(0x79,"read_addry","adc");this.opXI(0x7a,"pull",OPCODE_Y);this.opAII(0x7b,"transfer_w",OPCODE_D,OPCODE_A);this.opA(0x7c,"jmp_iaddrx");this.opMF(0x7d,"read_addrx","adc");this.opMF(0x7e,"adjust_addrx","ror");this.opMF(0x7f,"read_longx","adc");this.opA(0x80,"bra");this.opM(0x81,"sta_idpx");this.opA(0x82,"brl");this.opM(0x83,"sta_sr");this.opXI(0x84,"write_dp",OPCODE_Y);this.opMI(0x85,"write_dp",OPCODE_A);this.opXI(0x86,"write_dp",OPCODE_X);this.opM(0x87,"sta_ildp");this.opXII(0x88,"adjust_imm",OPCODE_Y,-1);this.opM(0x89,"read_bit_const");this.opMII(0x8a,"transfer",OPCODE_X,OPCODE_A);this.opA(0x8b,"phb");this.opXI(0x8c,"write_addr",OPCODE_Y);this.opMI(0x8d,"write_addr",OPCODE_A);this.opXI(0x8e,"write_addr",OPCODE_X);this.opMI(0x8f,"write_longr",OPCODE_Z);this.opAII(0x90,"branch",0x01,0);this.opM(0x91,"sta_idpy");this.opM(0x92,"sta_idp");this.opM(0x93,"sta_isry");this.opXII(0x94,"write_dpr",OPCODE_Y,OPCODE_X);this.opMII(0x95,"write_dpr",OPCODE_A,OPCODE_X);this.opXII(0x96,"write_dpr",OPCODE_X,OPCODE_Y);this.opM(0x97,"sta_ildpy");this.opMII(0x98,"transfer",OPCODE_Y,OPCODE_A);this.opMII(0x99,"write_addrr",OPCODE_A,OPCODE_Y);this.opE(0x9a,"txs");this.opXII(0x9b,"transfer",OPCODE_X,OPCODE_Y);this.opMI(0x9c,"write_addr",OPCODE_Z);this.opMII(0x9d,"write_addrr",OPCODE_A,OPCODE_X);this.opMII(0x9e,"write_addrr",OPCODE_Z,OPCODE_X);this.opMI(0x9f,"write_longr",OPCODE_X);this.opXF(0xa0,"read_const","ldy");this.opMF(0xa1,"read_idpx","lda");this.opXF(0xa2,"read_const","ldx");this.opMF(0xa3,"read_sr","lda");this.opXF(0xa4,"read_dp","ldy");this.opMF(0xa5,"read_dp","lda");this.opXF(0xa6,"read_dp","ldx");this.opMF(0xa7,"read_ildp","lda");this.opXII(0xa8,"transfer",OPCODE_A,OPCODE_Y);this.opMF(0xa9,"read_const","lda");this.opXII(0xaa,"transfer",OPCODE_A,OPCODE_X);this.opA(0xab,"plb");this.opXF(0xac,"read_addr","ldy");this.opMF(0xad,"read_addr","lda");this.opXF(0xae,"read_addr","ldx");this.opMF(0xaf,"read_long","lda");this.opAII(0xb0,"branch",0x01,1);this.opMF(0xb1,"read_idpy","lda");this.opMF(0xb2,"read_idp","lda");this.opMF(0xb3,"read_isry","lda");this.opXFI(0xb4,"read_dpr","ldy",OPCODE_X);this.opMFI(0xb5,"read_dpr","lda",OPCODE_X);this.opXFI(0xb6,"read_dpr","ldx",OPCODE_Y);this.opMF(0xb7,"read_ildpy","lda");this.opAII(0xb8,"flag",0x40,0x00);this.opMF(0xb9,"read_addry","lda");this.opX(0xba,"tsx");this.opXII(0xbb,"transfer",OPCODE_Y,OPCODE_X);this.opXF(0xbc,"read_addrx","ldy");this.opMF(0xbd,"read_addrx","lda");this.opXF(0xbe,"read_addry","ldx");this.opMF(0xbf,"read_longx","lda");this.opXF(0xc0,"read_const","cpy");this.opMF(0xc1,"read_idpx","cmp");this.opEI(0xc2,"pflag",0);this.opMF(0xc3,"read_sr","cmp");this.opXF(0xc4,"read_dp","cpy");this.opMF(0xc5,"read_dp","cmp");this.opMF(0xc6,"adjust_dp","dec");this.opMF(0xc7,"read_ildp","cmp");this.opXII(0xc8,"adjust_imm",OPCODE_Y,+1);this.opMF(0xc9,"read_const","cmp");this.opXII(0xca,"adjust_imm",OPCODE_X,-1);this.opA(0xcb,"wai");this.opXF(0xcc,"read_addr","cpy");this.opMF(0xcd,"read_addr","cmp");this.opMF(0xce,"adjust_addr","dec");this.opMF(0xcf,"read_long","cmp");this.opAII(0xd0,"branch",0x02,0);this.opMF(0xd1,"read_idpy","cmp");this.opMF(0xd2,"read_idp","cmp");this.opMF(0xd3,"read_isry","cmp");this.opE(0xd4,"pei");this.opMFI(0xd5,"read_dpr","cmp",OPCODE_X);this.opMF(0xd6,"adjust_dpx","dec");this.opMF(0xd7,"read_ildpy","cmp");this.opAII(0xd8,"flag",0x08,0x00);this.opMF(0xd9,"read_addry","cmp");this.opXI(0xda,"push",OPCODE_X);this.opA(0xdb,"stp");this.opA(0xdc,"jmp_iladdr");this.opMF(0xdd,"read_addrx","cmp");this.opMF(0xde,"adjust_addrx","dec");this.opMF(0xdf,"read_longx","cmp");this.opXF(0xe0,"read_const","cpx");this.opMF(0xe1,"read_idpx","sbc");this.opEI(0xe2,"pflag",1);this.opMF(0xe3,"read_sr","sbc");this.opXF(0xe4,"read_dp","cpx");this.opMF(0xe5,"read_dp","sbc");this.opMF(0xe6,"adjust_dp","inc");this.opMF(0xe7,"read_ildp","sbc");this.opXII(0xe8,"adjust_imm",OPCODE_X,+1);this.opMF(0xe9,"read_const","sbc");this.opA(0xea,"nop");this.opA(0xeb,"xba");this.opXF(0xec,"read_addr","cpx");this.opMF(0xed,"read_addr","sbc");this.opMF(0xee,"adjust_addr","inc");this.opMF(0xef,"read_long","sbc");this.opAII(0xf0,"branch",0x02,1);this.opMF(0xf1,"read_idpy","sbc");this.opMF(0xf2,"read_idp","sbc");this.opMF(0xf3,"read_isry","sbc");this.opE(0xf4,"pea");this.opMFI(0xf5,"read_dpr","sbc",OPCODE_X);this.opMF(0xf6,"adjust_dpx","inc");this.opMF(0xf7,"read_ildpy","sbc");this.opAII(0xf8,"flag",0x08,0x08);this.opMF(0xf9,"read_addry","sbc");this.opXI(0xfa,"pull",OPCODE_X);this.opA(0xfb,"xce");this.opE(0xfc,"jsr_iaddrx");this.opMF(0xfd,"read_addrx","sbc");this.opMF(0xfe,"adjust_addrx","inc");this.opMF(0xff,"read_longx","sbc")}SNESJS.CPU.prototype.optable=[];SNESJS.CPU.prototype.opA=function(a,b){var c=this;var d=getFunctionByName("SNESJS.CPU.OPS."+b);this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_Mx+a]=this.optable[TBL_mX+a]=this.optable[TBL_mx+a]=function(){d(c)}}SNESJS.CPU.prototype.opAII=function(a,b,c,d){var f=this;var e=getFunctionByName("SNESJS.CPU.OPS."+b);this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_Mx+a]=this.optable[TBL_mX+a]=this.optable[TBL_mx+a]=function(){e(f,c,d)}}SNESJS.CPU.prototype.opE=function(a,b){var c=this;var d=getFunctionByName("SNESJS.CPU.OPS."+b+"_2");this.optable[TBL_EM+a]=function(){d(c)};var f=getFunctionByName("SNESJS.CPU.OPS."+b+"_3");this.optable[TBL_MX+a]=this.optable[TBL_Mx+a]=this.optable[TBL_mX+a]=this.optable[TBL_mx+a]=function(){f(c)}}SNESJS.CPU.prototype.opEI=function(a,b,c){var d=this;var f=getFunctionByName("SNESJS.CPU.OPS."+b+"_2");this.optable[TBL_EM+a]=function(){f(d,c)};var e=getFunctionByName("SNESJS.CPU.OPS."+b+"_3");this.optable[TBL_MX+a]=this.optable[TBL_Mx+a]=this.optable[TBL_mX+a]=this.optable[TBL_mx+a]=function(){e(d,c)}}SNESJS.CPU.prototype.opEII=function(a,b,c,d){var f=this;var e=getFunctionByName("SNESJS.CPU.OPS."+b+"_2");this.optable[TBL_EM+a]=function(){e(f,c,d)};var g=getFunctionByName("SNESJS.CPU.OPS."+b+"_3");this.optable[TBL_MX+a]=this.optable[TBL_Mx+a]=this.optable[TBL_mX+a]=this.optable[TBL_mx+a]=function(){g(f,c,d)}}SNESJS.CPU.prototype.opM=function(a,b){var c=this;var d=getFunctionByName("SNESJS.CPU.OPS."+b+"_0");this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_Mx+a]=function(){d(c)};var f=getFunctionByName("SNESJS.CPU.OPS."+b+"_1");this.optable[TBL_mX+a]=this.optable[TBL_mx+a]=function(){f(c)}}SNESJS.CPU.prototype.opMI=function(a,b,c){var d=this;var f=getFunctionByName("SNESJS.CPU.OPS."+b+"_0");this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_Mx+a]=function(){f(d,c)};var e=getFunctionByName("SNESJS.CPU.OPS."+b+"_1");this.optable[TBL_mX+a]=this.optable[TBL_mx+a]=function(){e(d,c)}}SNESJS.CPU.prototype.opMII=function(a,b,c,d){var f=this;var e=getFunctionByName("SNESJS.CPU.OPS."+b+"_0");this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_Mx+a]=function(){e(f,c,d)};var g=getFunctionByName("SNESJS.CPU.OPS."+b+"_1");this.optable[TBL_mX+a]=this.optable[TBL_mx+a]=function(){g(f,c,d)}}SNESJS.CPU.prototype.opMF=function(a,b,c){var d=this;var f=getFunctionByName("SNESJS.CPU.OPS."+b+"_0");var e=getFunctionByName("SNESJS.CPU.OPS."+c+"_0");this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_Mx+a]=function(){f(d,e)};var g=getFunctionByName("SNESJS.CPU.OPS."+b+"_1");var h=getFunctionByName("SNESJS.CPU.OPS."+c+"_1");this.optable[TBL_mX+a]=this.optable[TBL_mx+a]=function(){g(d,h)}}SNESJS.CPU.prototype.opMFI=function(a,b,c,d){var f=this;var e=getFunctionByName("SNESJS.CPU.OPS."+b+"_0");var g=getFunctionByName("SNESJS.CPU.OPS."+c+"_0");this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_Mx+a]=function(){e(f,g,d)};var h=getFunctionByName("SNESJS.CPU.OPS."+b+"_1");var j=getFunctionByName("SNESJS.CPU.OPS."+c+"_1");this.optable[TBL_mX+a]=this.optable[TBL_mx+a]=function(){h(f,j,d)}}SNESJS.CPU.prototype.opX=function(a,b){var c=this;var d=getFunctionByName("SNESJS.CPU.OPS."+b+"_0");this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_mX+a]=function(){d(c)};var f=getFunctionByName("SNESJS.CPU.OPS."+b+"_1");this.optable[TBL_Mx+a]=this.optable[TBL_mx+a]=function(){f(c)}}SNESJS.CPU.prototype.opXI=function(a,b,c){var d=this;var f=getFunctionByName("SNESJS.CPU.OPS."+b+"_0");this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_mX+a]=function(){f(d,c)};var e=getFunctionByName("SNESJS.CPU.OPS."+b+"_1");this.optable[TBL_Mx+a]=this.optable[TBL_mx+a]=function(){e(d,c)}}SNESJS.CPU.prototype.opXII=function(a,b,c,d){var f=this;var e=getFunctionByName("SNESJS.CPU.OPS."+b+"_0");this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_mX+a]=function(){e(f,c,d)};var g=getFunctionByName("SNESJS.CPU.OPS."+b+"_1");this.optable[TBL_Mx+a]=this.optable[TBL_mx+a]=function(){g(f,c,d)}}SNESJS.CPU.prototype.opXF=function(a,b,c){var d=this;var f=getFunctionByName("SNESJS.CPU.OPS."+b+"_0");var e=getFunctionByName("SNESJS.CPU.OPS."+c);this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_mX+a]=function(){f(d,e)};var g=getFunctionByName("SNESJS.CPU.OPS."+b+"_1");var h=getFunctionByName("SNESJS.CPU.OPS."+c);this.optable[TBL_Mx+a]=this.optable[TBL_mx+a]=function(){g(d,h)}}SNESJS.CPU.prototype.opXFI=function(a,b,c,d){var f=this;var e=getFunctionByName("SNESJS.CPU.OPS."+b+"_0");var g=getFunctionByName("SNESJS.CPU.OPS."+c);this.optable[TBL_EM+a]=this.optable[TBL_MX+a]=this.optable[TBL_mX+a]=function(){e(f,g,d)};var h=getFunctionByName("SNESJS.CPU.OPS."+b+"_1");var j=getFunctionByName("SNESJS.CPU.OPS."+c);this.optable[TBL_Mx+a]=this.optable[TBL_mx+a]=function(){h(f,j,d)}}SNESJS.CPU.OPS._4=[2,2,2,2,2,2,2,2,1,5,1,1,3,3,3,4,2,2,2,2,2,2,2,2,1,3,1,1,3,3,3,4,3,2,4,2,2,2,2,2,1,5,1,1,3,3,3,4,2,2,2,2,2,2,2,2,1,3,1,1,3,3,3,4,1,2,2,2,3,2,2,2,1,5,1,1,3,3,3,4,2,2,2,2,3,2,2,2,1,3,1,1,4,3,3,4,1,2,3,2,2,2,2,2,1,5,1,1,3,3,3,4,2,2,2,2,2,2,2,2,1,3,1,1,3,3,3,4,2,2,3,2,2,2,2,2,1,5,1,1,3,3,3,4,2,2,2,2,2,2,2,2,1,3,1,1,3,3,3,4,6,2,6,2,2,2,2,2,1,5,1,1,3,3,3,4,2,2,2,2,2,2,2,2,1,3,1,1,3,3,3,4,6,2,2,2,2,2,2,2,1,5,1,1,3,3,3,4,2,2,2,2,2,2,2,2,1,3,1,1,3,3,3,4,6,2,2,2,2,2,2,2,1,5,1,1,3,3,3,4,2,2,2,2,3,2,2,2,1,3,1,1,3,3,3,4];SNESJS.CPU.OPS={nop:function(a){a.last_cycle();a.op_io_irq()},wdm:function(a){a.last_cycle();a.op_readpc()},xba:function(a){a.op_io();a.last_cycle();a.op_io();a.regs.a.l^=a.regs.a.h;a.regs.a.h^=a.regs.a.l;a.regs.a.l^=a.regs.a.h;a.regs.p.n=(a.regs.a.l&0x80)!=0;a.regs.p.z=a.regs.a.l==0},move_b:function(a,b){a.dp=a.op_readpc();a.sp=a.op_readpc();a.regs.db=a.dp;a.rd.l=a.op_readlong((a.sp<<16)|regs.x.w);a.op_writelong((a.dp<<16)|a.regs.y.w,a.rd.l);a.op_io();a.regs.x.l+=b;a.regs.y.l+=b;a.last_cycle();a.op_io();if(a.regs.a.w--!=0){a.regs.pc.w-=3}},move_w:function(a,b){a.dp=a.op_readpc();a.sp=a.op_readpc();a.regs.db=a.dp;a.rd.l=a.op_readlong((a.sp<<16)|regs.x.w);a.op_writelong((a.dp<<16)|a.regs.y.w,a.rd.l);a.op_io();a.regs.x.w+=b;a.regs.y.w+=b;a.last_cycle();a.op_io();if(a.regs.a.w--!=0){a.regs.pc.w-=3}},interrupt_e:function(a,b,c){a.op_readpc();a.op_writestack(a.regs.pc.h);a.op_writestack(a.regs.pc.l);a.op_writestack(a.regs.p);a.rd.l=a.op_readlong(b+0);a.regs.pc.b=0;a.regs.p.i=1;a.regs.p.d=0;a.last_cycle();a.rd.h=a.op_readlong(b+1);a.regs.pc.w=a.rd.w},interrupt_n:function(a,b,c){a.op_readpc();a.op_writestack(a.regs.pc.h);a.op_writestack(a.regs.pc.l);a.op_writestack(a.regs.p);a.rd.l=a.op_readlong(c+0);a.regs.pc.b=0;a.regs.p.i=1;a.regs.p.d=0;a.last_cycle();a.rd.h=a.op_readlong(c+1);a.regs.pc.w=a.rd.w},stp:function(a){a.regs.wai=true;while(a.regs.wai){a.last_cycle();a.op_io()}},xce:function(a){a.last_cycle();a.op_io_irq();var b=a.regs.p.c;a.regs.p.c=a.regs.e;a.regs.e=b;if(a.regs.e){a.regs.p|=0x30;a.regs.s.h=0x01}if(regs.p.x){a.regs.x.h=0x00;a.regs.y.h=0x00}a.update_table()},flag:function(a,b,c){a.last_cycle();a.op_io_irq();a.regs.p=(a.regs.p&~b)|c},pflag_e:function(a,b){a.rd.l=a.op_readpc();a.last_cycle();a.op_io();a.regs.p=(b?a.regs.p|a.rd.l:a.regs.p&~a.rd.l);a.regs.p.assign(a.regs.p|0x30);if(a.regs.p.x){a.regs.x.h=0x00;a.regs.y.h=0x00}a.update_table()},pflag_n:function(a,b){a.rd.l=a.op_readpc();a.last_cycle();a.op_io();a.regs.p=(b?a.regs.p|a.rd.l:a.regs.p&~a.rd.l);if(a.regs.p.x){a.regs.x.h=0x00;a.regs.y.h=0x00}a.update_table()},transfer_b:function(a,b,c){a.last_cycle();a.op_io_irq();a.regs.r[c].l=a.regs.r[b].l;a.regs.p.n=(a.regs.r[c].l&0x8000);a.regs.p.z=(a.regs.r[c].l==0)},transfer_w:function(a,b,c){a.last_cycle();a.op_io_irq();a.regs.r[c].w=a.regs.r[b].w;a.regs.p.n=(a.regs.r[c].w&0x8000);a.regs.p.z=(a.regs.r[c].w==0)},tcs_e:function(a){a.last_cycle();a.op_io_irq();a.regs.s.l=a.regs.a.l},tcs_n:function(a){a.last_cycle();a.op_io_irq();a.regs.s.w=a.regs.a.w},tsx_b:function(a){a.last_cycle();a.op_io_irq();a.regs.x.l=a.regs.s.l;a.regs.p.n=(a.regs.x.l&0x80)!=0;a.regs.p.z=a.regs.x.l==0},tsx_w:function(a){a.last_cycle();a.op_io_irq();a.regs.x.w=a.regs.s.w;a.regs.p.n=(a.regs.x.w&0x80)!=0;a.regs.p.z=a.regs.x.w==0},tsx_e:function(a){a.last_cycle();a.op_io_irq();a.regs.s.l=a.regs.x.l},tsx_n:function(a){a.last_cycle();a.op_io_irq();a.regs.s.w=a.regs.x.w},push_b:function(a,b){a.op_io();a.last_cycle();a.op_writestack(a.regs.r[b].l)},push_w:function(a,b){a.op_io();a.op_writestack(a.regs.r[b].h);a.last_cycle();a.op_writestack(a.regs.r[b].l)},phd_e:function(a){a.op_io();a.op_writestackn(a.regs.d.h);a.op_writestackn(a.regs.d.l)},phd_n:function(a){a.op_io();a.op_writestackn(a.regs.d.h);a.last_cycle();a.op_writestackn(a.regs.d.l)},phb:function(a){a.op_io();a.last_cycle();a.op_writestack(a.regs.db)},phk:function(a){a.op_io();a.last_cycle();a.op_writestack(a.regs.pc.b)},php:function(a){a.op_io();a.last_cycle();a.op_writestack(a.regs.p)},pull_b:function(a,b){a.op_io();a.op_io();a.last_cycle();a.regs.r[b].l=a.op_readstack();a.regs.p.n=(a.regs.r[b].l&0x80)!=0;a.regs.p.z=(a.regs.r[b].l==0)},pull_w:function(a,b){a.op_io();a.op_io();a.last_cycle();a.regs.r[b].l=a.op_readstack();a.regs.p.n=(a.regs.r[b].w&0x8000)!=0;a.regs.p.z=(a.regs.r[b].w==0)},pld_e:function(a){a.op_io();a.op_io();a.regs.d.l=a.op_readstackn();a.last_cycle();a.regs.d.h=a.op_readstackn();a.regs.p.n=(a.regs.d.w&0x8000)!=0;a.regs.p.z=(a.regs.d.w==0);a.regs.s.h=0x01},pld_n:function(a){a.op_io();a.op_io();a.regs.d.l=a.op_readstackn();a.last_cycle();a.regs.d.h=a.op_readstackn();a.regs.p.n=(a.regs.d.w&0x8000)!=0;a.regs.p.z=(a.regs.d.w==0)},plb:function(a){a.op_io();a.op_io();a.last_cycle();a.op_readstack();a.regs.p.n=(a.regs.db&0x80)!=0;a.regs.p.z=(a.regs.db==0)},plp_e:function(a){a.op_io();a.op_io();a.last_cycle();a.regs.p=a.op_readstack()|0x30;if(a.regs.p.x){a.regs.x.h=0x00;a.regs.y.h=0x00}a.update_table()},plp_n:function(a){a.op_io();a.op_io();a.last_cycle();a.regs.p=a.op_readstack();if(a.regs.p.x){a.regs.x.h=0x00;a.regs.y.h=0x00}a.update_table()},branch:function(a,b,c){if((a.regs.p&b)!=c){a.last_cycle();a.rd.l=a.op_readpc()}else{a.rd.l=a.op_readpc();a.aa.w=a.regs.pc.d+a.rd.l;a.op_io_cond6(a.aa.w);a.last_cycle();a.op_io();a.regs.pc.w=a.aa.w}},bra:function(a){a.rd.l=a.op_readpc();a.aa.w=a.regs.pc.d+a.rd.l;a.op_io_cond6(aa.w);a.last_cycle();a.op_io();a.regs.pc.w=a.aa.w},brl:function(a){a.rd.l=a.op_readpc();a.rd.h=a.op.readpc();a.last_cycle();a.op_io();a.regs.pc.w=a.regs.pc.d+a.rd.w},jmp_addr:function(a){a.rd.l=a.op_readpc();a.last_cycle();a.rd.h=a.op_readpc();a.regs.pc.w=a.rd.w},jmp_long:function(a){a.rd.l=a.op_readpc();a.rd.h=a.op_readpc();a.last_cycle();a.rd.b=a.op_readpc();a.regs.pc.d=a.rd.d&0xffffff},jmp_iaddr:function(a){a.aa.l=a.op_readpc();a.aa.h=a.op_readpc();a.rd.l=a.op_readaddr(aa.w+0);a.last_cycle();a.rd.h=a.op_readaddr(aa.w+1);a.regs.pc.w=a.rd.w},jmp_iaddrx:function(a){a.aa.l=a.op_readpc();a.aa.h=a.op_readpc();a.op_io();a.rd.l=a.op_readpbr((uint)(aa.w+regs.x.w+0));a.last_cycle();a.rd.h=a.op_readpbr((uint)(aa.w+regs.x.w+1));a.regs.pc.w=a.rd.w},jmp_iladdr:function(a){a.aa.l=a.op_readpc();a.aa.h=a.op_readpc();a.rd.l=a.op_readaddr(a.aa.w+0);a.rd.h=a.op_readaddr(a.aa.w+1);a.last_cycle();a.rd.b=a.op_readaddr(a.aa.w+2);a.regs.pc.d=a.rd.d&0xffffff},jsr_addr:function(a){a.aa.l=a.op_readpc();a.aa.h=a.op_readpc();a.op_io();a.regs.pc.w--;a.op_writestack(a.regs.pc.h);a.last_cycle();a.op_writestack(a.regs.pc.l);a.regs.pc.w=a.aa.w},jsr_long_e:function(a){},jsr_long_n:function(a){},jsr_iaddrx_e:function(a){},jsr_iaddrx_n:function(a){},rti_e:function(a){},rti_n:function(a){},rts:function(a){},rtl_e:function(a){},rtl_n:function(a){},nop:function(a){a.last_cycle();a.op_io_irq()},wdm:function(a){a.last_cycle();a.op_readpc()},xba:function(a){a.op_io();a.last_cycle();a.op_io();a.regs.a.l^=a.regs.a.h;a.regs.a.h^=a.regs.a.l;a.regs.a.l^=a.regs.a.h;a.regs.p.n=(a.regs.a.l&0x80)==0x80;a.regs.p.z=(a.regs.a.l==0)},move_b:function(a,b){a.dp=a.op_readpc();a.sp=a.op_readpc();a.regs.db=a.dp;a.rd.l=a.op_readlong((a.sp<<16)|a.regs.x.w);a.op_writelong(((a.dp<<16)|a.regs.y.w),a.rd.l);a.op_io();a.regs.x.l+=b;a.regs.y.l+=b;a.last_cycle();a.op_io();if(a.regs.a.w--==0x01){a.regs.pc.w-=3}},move_w:function(a,b){a.dp=a.op_readpc();a.sp=a.op_readpc();a.regs.db=a.dp;a.rd.l=a.op_readlong((a.sp<<16)|a.regs.x.w);a.op_writelong((a.dp<<16)|a.regs.y.w,a.rd.l);a.op_io();a.regs.x.w+=a.adjust;a.regs.y.w+=a.adjust;a.last_cycle();a.op_io();if(regs.a.w--==0x01){regs.pc.w-=3}},interrupt_e:function(a,b,c){a.op_readpc();a.op_writestack(a.regs.pc.h);a.op_writestack(a.regs.pc.l);a.op_writestack(a.regs.p);a.rd.l=a.op_readlong(b+0);a.regs.pc.b=0x00;a.regs.p.i=true;a.regs.p.d=false;a.last_cycle();a.rd.h=a.op_readlong(b+1);a.regs.pc.w=rd.w},interrupt_n:function(a,b,c){a.op_readpc();a.op_writestack(a.regs.pc.h);a.op_writestack(a.regs.pc.l);a.op_writestack(a.regs.p);op_writestack(regs.p);a.rd.l=a.op_readlong(c+0);a.regs.pc.b=0x00;a.regs.p.i=true;a.regs.p.d=false;a.last_cycle();a.rd.h=a.op_readlong(c+1);a.regs.pc.w=rd.w},stp:function(a){a.regs.wai=true;while(a.regs.wai){a.last_cycle();a.op_io()}},wai:function(a){a.regs.wai=true;while(a.regs.wai){a.last_cycle();a.op_io()}a.op_io()},xce:function(a){a.last_cycle();a.op_io_irq();var b=a.regs.p.c;a.regs.p.c=a.regs.e;a.regs.e=b;if(a.regs.e){a.regs.p.assign(a.regs.p|0x30);a.regs.s.h=0x01}if(a.regs.p.x){a.regs.x.h=0x00;a.regs.y.h=0x00}a.update_table()},flag:function(a,b,c){a.last_cycle();a.op_io_irq();a.regs.p.assign((regs.p&~b)|c)},pflag_e:function(a,b){a.rd.l=a.op_readpc();a.last_cycle();a.op_io();a.regs.p.assign((b==0x1)?a.regs.p|a.rd.l:a.regs.p&~rd.l);a.regs.p.assign(a.regs.p|0x30);if(a.regs.p.x){a.regs.x.h=0x00;a.regs.y.h=0x00}a.update_table()},pflag_n:function(a,b){a.rd.l=a.op_readpc();a.last_cycle();a.op_io();a.regs.p.assign((b==0x1)?a.regs.p|a.rd.l:a.regs.p&~rd.l);if(a.regs.p.x){a.regs.x.h=0x00;a.regs.y.h=0x00}a.update_table()},transfer_b:function(a,b,c){a.last_cycle();a.op_io_irq();a.regs.r[c].l=a.regs.r[b].l;a.regs.p.n=(a.regs.r[c].l&0x80)==0x80;a.regs.p.z=(a.regs.r[c].l==0)},transfer_w:function(a,b,c){a.last_cycle();a.op_io_irq();a.regs.r[c].w=a.regs.r[b].w;a.regs.p.n=(regs.r[c].w&0x8000)==0x8000;a.regs.p.z=regs.r[c].w==0},tcs_e:function(a){a.last_cycle();a.op_io_irq();a.regs.s.l=a.regs.a.l},tcs_n:function(a){a.last_cycle();a.op_io_irq();a.regs.s.w=a.regs.a.w},tsx_b:function(a){a.last_cycle();a.op_io_irq();a.regs.x.l=a.regs.s.l;a.regs.p.n=(a.regs.x.l&0x80)==0x80;a.regs.p.z=a.regs.x.l==0},tsx_w:function(a){a.last_cycle();a.op_io_irq();a.regs.x.w=a.regs.s.w;a.regs.p.n=(a.regs.x.w&0x8000)==0x8000;a.regs.p.z=a.regs.x.w==0},txs_e:function(a){a.last_cycle();a.op_io_irq();a.regs.s.l=a.regs.x.l},txs_n:function(a){a.last_cycle();a.op_io_irq();a.regs.s.w=a.regs.x.w},push_b:function(a,b){a.op_io();a.last_cycle();a.op_writestack(a.regs.r[b].l)},push_w:function(a,b){a.op_io();a.op_writestack(regs.r[b].h);a.last_cycle();a.op_writestack(regs.r[b].l)},phd_e:function(a){a.op_io();a.op_writestackn(a.regs.d.h);a.last_cycle();a.op_writestackn(a.regs.d.l);a.regs.s.h=0x01},phd_n:function(a){a.op_io();a.op_writestackn(a.regs.d.h);a.last_cycle();a.op_writestackn(a.regs.d.l)}};SNESJS.CPU.prototype.dma_transfer_valid=function(a,b){return!(a==0x80&&((b&0xfe0000)==0x7e0000||(b&0x40e000)==0x0000))}SNESJS.CPU.prototype.dma_addr_valid=function(a){if((a&0x40ff00)==0x2100)return false;if((a&0x40fe00)==0x4000)return false;if((a&0x40ffe0)==0x4200)return false;if((a&0x40ff80)==0x4300)return false;return true}SNESJS.CPU.prototype.dma_read=function(a){if(this.dma_addr_valid(a)==false)return 0x00;return this.snes.bus.read(a)}SNESJS.CPU.prototype.dma_write=function(a,b,c){if(a){this.snes.bus.write(b,c)}}SNESJS.CPU.prototype.dma_transfer=function(a,b,c){if(a==0){data=this.dma_read(c);this.add_clocks(8);this.dma_write(this.dma_transfer_valid(b,c),0x2100|b,data)}else{data=this.dma_transfer_valid(b,c)?this.snes.bus.read(0x2100|b):0x00;this.add_clocks(8);this.dma_write(this.dma_addr_valid(c),c,data)}}SNESJS.CPU.prototype.dma_bbus=function(a,b){switch(channel[a].transfer_mode){default:case 0:return(channel[a].dest_addr);case 1:return(channel[a].dest_addr+(b&1));case 2:return(channel[a].dest_addr);case 3:return(channel[a].dest_addr+((b>>1)&1));case 4:return(channel[a].dest_addr+(b&3));case 5:return(channel[a].dest_addr+(b&1));case 6:return(channel[a].dest_addr);case 7:return(channel[a].dest_addr+((b>>1)&1))}}SNESJS.CPU.prototype.dma_addr=function(a){var b=(channel[a].source_bank<<16)|(channel[a].source_addr);if(channel[a].fixed_transfer==false){if(channel[a].reverse_transfer==false){channel[a].source_addr++}else{channel[a].source_addr--}}return b}SNESJS.CPU.prototype.hdma_addr=function(a){return(channel[a].source_bank<<16)|(channel[a].hdma_addr++)}SNESJS.CPU.prototype.hdma_iaddr=function(a){return(channel[a].indirect_bank<<16)|(channel[a].indirect_addr++)}SNESJS.CPU.prototype.dma_run=function(){this.add_clocks(16);for(var a=0;a<8;a++){if(channel[a].dma_enabled==false)continue;this.add_clocks(8);var b=0;do{dma_transfer(channel[a].direction,this.dma_bbus(a,b++),this.dma_addr(a))}while(channel[a].dma_enabled&&--channel[a].transfer_size);channel[a].dma_enabled=false}this.irq_lock=true}SNESJS.CPU.prototype.hdma_active_after=function(a){for(var b=a+1;a<8;a++){if(channel[a].hdma_enabled&&!channel[a].hdma_completed)return true}return false}SNESJS.CPU.prototype.hdma_update=function(a){if((channel[a].line_counter&0x7f)==0){channel[a].line_counter=this.dma_read(hdma_addr(a));channel[a].hdma_completed=(channel[a].line_counter==0);channel[a].hdma_do_transfer=!channel[a].hdma_completed;this.add_clocks(8);if(channel[a].indirect){channel[a].indirect_addr=this.dma_read(this.hdma_addr(a))<<8;this.add_clocks(8);channel[a].indirect_addr>>=8;channel[a].indirect_addr|=this.dma_read(this.hdma_addr(a))<<8;this.add_clocks(8)}}}SNESJS.CPU.transfer_length=[1,2,2,4,4,4,2,4];SNESJS.CPU.prototype.hdma_run=function(){var a=0;for(var b=0;b<8;b++){if(channel[b].hdma_enabled)a++}if(a==0)return;this.add_clocks(16);for(var b=0;b<8;b++){if(channel[b].hdma_enabled==false||channel[b].hdma_completed==true)continue;channel[b].dma_enabled=false;if(channel[b].hdma_do_transfer){var c=transfer_length[channel[b].transfer_mode];for(var d=0;d<c;d++){var f=channel[b].indirect==false?hdma_addr(b):hdma_iaddr(b);dma_transfer(channel[b].direction,dma_bbus(b,d),f)}}}for(var b=0;b<8;b++){if(channel[b].hdma_enabled==false||channel[b].hdma_completed==true)continue;channel[b].line_counter--;channel[b].hdma_do_transfer=channel[b].line_counter&0x80;hdma_update(b)}this.irq_lock=true}SNESJS.CPU.prototype.hdma_init=function(){var a=0;for(var b=0;b<8;b++){channel[b].hdma_completed=false;channel[b].hdma_do_transfer=false;if(channel[b].hdma_enabled){a++}}if(a==0)return;this.add_clocks(16);for(var b=0;b<8;b++){if(!channel[b].hdma_enabled)continue;channel[b].dma_enabled=false;channel[b].hdma_addr=channel[b].source_addr;channel[b].line_counter=0;this.hdma_update(b)}this.irq_lock=true}SNESJS.CPU.prototype.dma_reset=function(){for(var a=0;a<8;a++){channel[a].dma_enabled=false;channel[a].hdma_enabled=false;channel[a].direction=1;channel[a].indirect=true;channel[a].unused=true;channel[a].reverse_transfer=true;channel[a].fixed_transfer=true;channel[a].transfer_mode=0x07;channel[a].dest_addr=0xff;channel[a].source_addr=0xffff;channel[a].source_bank=0xff;channel[a].transfer_size=0xffff;channel[a].indirect_addr=0xffff;channel[a].indirect_bank=0xff;channel[a].hdma_addr=0xff;channel[a].line_counter=0xff;channel[a].unknown=0xff;channel[a].hdma_completed=false;channel[a].hdma_do_transfer=false}}SNESJS.CPU.prototype.op_readpc=function(){return this.op_read((this.regs.pc.b<<16)+this.regs.pc.w++)}SNESJS.CPU.prototype.op_readstack=function(){this.regs.e?this.regs.s.l++:this.regs.s.w++;return this.op_read(this.regs.s.w)}SNESJS.CPU.prototype.op_readstackn=function(){return this.op_read(++this.regs.s.w)}SNESJS.CPU.prototype.op_readaddr=function(a){return this.op_read(a&0xffff)}SNESJS.CPU.prototype.op_readlong=function(a){return this.op_read(a&0xffffff)}SNESJS.CPU.prototype.op_readdbr=function(a){return this.op_read(((this.regs.db<<16)+a)&0xffffff)}SNESJS.CPU.prototype.op_readpbr=function(a){return this.op_read((this.regs.pc.b<<16)+(a&0xffff))}SNESJS.CPU.prototype.op_readdp=function(a){if(this.regs.e&&this.regs.d.l==0x00){return this.op_read((this.regs.d&0xff00)+((this.regs.d+(a&0xffff))&0xff))}else{return this.op_read((this.regs.d+(a&0xffff))&0xffff)}}SNESJS.CPU.prototype.op_readsp=function(a){return this.op_read((this.regs.s+(a&0xffff))&0xffff)}SNESJS.CPU.prototype.op_writestack=function(a){this.op_write(this.regs.s.w,a);this.regs.e?this.regs.s.l--:this.regs.s.w--}SNESJS.CPU.prototype.op_writestackn=function(a){this.op_write(this.regs.s.w--,a)}SNESJS.CPU.prototype.op_writeaddr=function(a,b){this.op_write(a&0xffff,b)}SNESJS.CPU.prototype.op_writelong=function(a,b){this.op_write(a&0xffffff,b)}SNESJS.CPU.prototype.op_writedbr=function(a,b){this.op_write(((this.regs.db<<16)+a)&0xffffff,b)}SNESJS.CPU.prototype.op_writepbr=function(a,b){this.op_write((this.regs.pc.b<<16)+(a&0xffff),b)}SNESJS.CPU.prototype.op_writedp=function(a,b){if(this.regs.e&&this.regs.d.l==0x00){this.op_write((this.regs.d&0xff00)+((this.regs.d+(a&0xffff))&0xff),b)}else{this.op_write((this.regs.d+(a&0xffff))&0xffff,b)}}SNESJS.CPU.prototype.op_writesp=function(a,b){this.op_write((this.regs.s+(a&0xffff))&0xffff,b)}SNESJS.CPU.prototype.pio=function(){return this.status.pio}SNESJS.CPU.prototype.joylatch=function(){return this.status.joypad_strobe_latch}SNESJS.CPU.prototype.interrupt_pending=function(){return false}SNESJS.CPU.prototype.port_read=function(a){return this.port_data[a&3]}SNESJS.CPU.prototype.port_write=function(a,b){this.port_data[a&3]=b}SNESJS.CPU.prototype.op_io=function(){this.add_clocks(6)}SNESJS.CPU.prototype.op_read=function(a){this.regs.mdr=this.snes.bus.read(a);this.add_clocks(speed(a));return this.regs.mdr}SNESJS.CPU.prototype.op_write=function(a,b){this.add_clocks(speed(a));this.snes.bus.write(a,this.regs.mdr=b)}SNESJS.CPU.prototype.speed=function(a){if(a&0x408000){if(a&0x800000){return status.rom_speed}return 8}if((a+0x6000)&0x4000){return 8}if((a-0x4000)&0x7e00){return 6}return 12}SNESJS.CPU.prototype.mmio_read=function(a){if((a&0xffc0)==0x2140){synchronize_smp();return this.snes.smp.port_read(new uint2(a&3))}switch(a&0xffff){case 0x2180:var b=this.snes.bus.read(0x7e0000|this.status.wram_addr);this.status.wram_addr=(this.status.wram_addr+1)&0x01ffff;return b;case 0x4016:var b=regs.mdr&0xfc;b|=(Input.input.port_read(false)&3);return b;case 0x4017:var b=(this.status.regs.mdr&0xe0)|0x1c;b|=(Input.input.port_read(true)&3);return b;case 0x4210:var b=this.status.regs.mdr&0x70;b|=((this.status.nmi_line?1:0)<<7);b|=0x02;this.status.nmi_line=false;return b;case 0x4211:var b=this.status.regs.mdr&0x7f;b|=(this.status.irq_line?1:0)<<7;this.status.irq_line=false;return b;case 0x4212:var b=(this.status.regs.mdr&0x3e);vbstart=this.snes.ppu.overscan()?240:225;if(this.snes.ppucounter.vcounter()>=vbstart&&this.snes.ppucounter.vcounter()<=vbstart+2){b|=0x01}if(this.snes.ppucounter.hcounter()<=2||this.snes.ppucounter.hcounter()>=1096){b|=0x40}if(this.snes.ppucounter.vcounter()>=vbstart){b|=0x80}return b;case 0x4213:return this.status.pio;case 0x4214:return this.status.rddiv>>0;case 0x4215:return this.status.rddiv>>8;case 0x4216:return this.status.rdmpy>>0;case 0x4217:return this.status.rdmpy>>8;case 0x4218:return this.status.joy1l;case 0x4219:return this.status.joy1h;case 0x421a:return this.status.joy2l;case 0x421b:return this.status.joy2h;case 0x421c:return this.status.joy3l;case 0x421d:return this.status.joy3h;case 0x421e:return this.status.joy4l;case 0x421f:return this.status.joy4h}if((a&0xff80)==0x4300){i=(a>>4)&7;switch(a&0xff8f){case 0x4300:return((channel[i].direction?1:0)<<7)|((channel[i].indirect?1:0)<<6)|((channel[i].unused?1:0)<<5)|((channel[i].reverse_transfer?1:0)<<4)|((channel[i].fixed_transfer?1:0)<<3)|(channel[i].transfer_mode<<0);case 0x4301:return channel[i].dest_addr;case 0x4302:return channel[i].source_addr>>0;case 0x4303:return channel[i].source_addr>>8;case 0x4304:return channel[i].source_bank;case 0x4305:return channel[i].union.transfer_size>>0;case 0x4306:return channel[i].union.transfer_size>>8;case 0x4307:return channel[i].indirect_bank;case 0x4308:return channel[i].hdma_addr>>0;case 0x4309:return channel[i].hdma_addr>>8;case 0x430a:return channel[i].line_counter;case 0x430b:case 0x430f:return channel[i].unknown}}return this.status.regs.mdr}SNESJS.CPU.prototype.mmio_write=function(a,b){if((a&0xffc0)==0x2140){this.status.synchronize_smp();this.status.port_write((a&3),b);return}switch(a&0xffff){case 0x2180:this.snes.bus.write(new uint24(0x7e0000|this.status.wram_addr),b);this.status.wram_addr=(this.status.wram_addr+1)&0x01ffff;return;case 0x2181:this.status.wram_addr=(this.status.wram_addr&0x01ff00)|(b<<0);return;case 0x2182:this.status.wram_addr=(this.status.wram_addr&0x0100ff)|(b<<8);return;case 0x2183:this.status.wram_addr=(this.status.wram_addr&0x00ffff)|((b&1)<<16);return;case 0x4016:this.snes.input.port1.latch(b&1);this.snes.input.port2.latch(b&1);return;case 0x4200:var c=this.status.nmi_enabled;var d=this.status.virq_enabled;var f=this.status.hirq_enabled;this.status.nmi_enabled=(b&0x80)!=0;this.status.virq_enabled=(b&0x20)!=0;this.status.hirq_enabled=(b&0x10)!=0;this.status.auto_joypad_poll_enabled=(b&0x01)!=0;if(!c&&this.status.nmi_enabled&&this.status.nmi_line){this.status.nmi_transition=true}if(this.status.virq_enabled&&!this.status.hirq_enabled&&this.status.irq_line){this.status.irq_transition=true}if(!this.status.virq_enabled&&!this.status.hirq_enabled){this.status.irq_line=false;this.status.irq_transition=false}this.status.irq_lock=true;return;case 0x4201:if((this.status.pio&0x80)!=0&&(b&0x80)==0){this.snes.ppu.latch_counters()}this.status.pio=b;case 0x4202:this.status.wrmpya=b;return;case 0x4203:this.status.wrmpyb=b;this.status.rdmpy=(this.status.wrmpya*this.status.wrmpyb);return;case 0x4204:this.status.wrdiva=((this.status.wrdiva&0xff00)|(b<<0));return;case 0x4205:this.status.wrdiva=((b<<8)|(this.status.wrdiva&0x00ff));return;case 0x4206:this.status.wrdivb=b;this.status.rddiv=((this.status.wrdivb!=0)?this.status.wrdiva/this.status.wrdivb:0xffff);this.status.rdmpy=((this.status.wrdivb!=0)?this.status.wrdiva%this.status.wrdivb:this.status.wrdiva);return;case 0x4207:this.status.htime=((this.status.htime&0x0100)|(b<<0));return;case 0x4208:this.status.htime=(((b&1)<<8)|(this.status.htime&0x00ff));return;case 0x4209:this.status.vtime=((this.status.vtime&0x0100)|(b<<0));return;case 0x420a:this.status.vtime=(((b&1)<<8)|(this.status.vtime&0x00ff));return;case 0x420b:for(var e=0;e<8;e++){channel[e].dma_enabled=(b&(1<<e))!=0}if(b!=0){dma_run()}return;case 0x420c:for(var e=0;e<8;e++){channel[e].hdma_enabled=(b&(1<<e))!=0}return;case 0x420d:this.status.rom_speed=(b&1)!=0?6:8;return}if((a&0xff80)==0x4300){var e=(a>>4)&7;switch(a&0xff8f){case 0x4300:channel[e].direction=(b&0x80)!=0;channel[e].indirect=(b&0x40)!=0;channel[e].unused=(b&0x20)!=0;channel[e].reverse_transfer=(b&0x10)!=0;channel[e].fixed_transfer=(b&0x08)!=0;channel[e].transfer_mode=(b&0x07);return;case 0x4301:channel[e].dest_addr=b;return;case 0x4302:channel[e].source_addr=((channel[e].source_addr&0xff00)|(b<<0));return;case 0x4303:channel[e].source_addr=((b<<8)|(channel[e].source_addr&0x00ff));return;case 0x4304:channel[e].source_bank=b;return;case 0x4305:channel[e].union.transfer_size=((channel[e].union.transfer_size&0xff00)|(b<<0));return;case 0x4306:channel[e].union.transfer_size=((b<<8)|(channel[e].union.transfer_size&0x00ff));return;case 0x4307:channel[e].indirect_bank=b;return;case 0x4308:channel[e].hdma_addr=((channel[e].hdma_addr&0xff00)|(b<<0));return;case 0x4309:channel[e].hdma_addr=((b<<8)|(channel[e].hdma_addr&0x00ff));return;case 0x430a:channel[e].line_counter=b;return;case 0x430b:case 0x430f:channel[e].unknown=b;return}}}SNESJS.CPU.Regs=function(){this.pc=new SNESJS.CPU.Reg24();this.p=new SNESJS.CPU.RegFlag();var a=[];this.a=a[0]=new SNESJS.CPU.Reg16();this.x=a[1]=new SNESJS.CPU.Reg16();this.y=a[2]=new SNESJS.CPU.Reg16();this.z=a[3]=new SNESJS.CPU.Reg16();this.s=a[4]=new SNESJS.CPU.Reg16();this.d=a[5]=new SNESJS.CPU.Reg16();this.r=a;this.db=0;this.e=false;this.irq=false;this.wai=false;this.mdr=0;this.z.d=0}SNESJS.CPU.RegFlag=function(){this.n=false;this.v=false;this.m=false;this.x=false;this.d=false;this.i=false;this.z=false;this.c=false}SNESJS.CPU.RegFlag.prototype.assign=function(a){this.n=(a&0x80)==0x80;this.v=(a&0x40)==0x40;this.m=(a&0x20)==0x20;this.x=(a&0x10)==0x10;this.d=(a&0x08)==0x08;this.i=(a&0x04)==0x04;this.z=(a&0x02)==0x02;this.c=(a&0x01)==0x01}SNESJS.CPU.RegFlag.prototype.valueOf=function(){return(this.n?0x80:0x00)|(this.v?0x40:0x00)|(this.m?0x20:0x00)|(this.x?0x10:0x00)|(this.d?0x08:0x00)|(this.i?0x04:0x00)|(this.z?0x02:0x00)|(this.c?0x01:0x00)}SNESJS.CPU.Reg16=function(){this.w=0;this.l=0;this.h=0}SNESJS.CPU.Reg24=function(){this.d=0;this.w=0;this.wh=0;this.l=0;this.h=0;this.b=0;this.bh=0}SNESJS.CPU.Status=function(){this.nmi_valid=false;this.nmi_line=false;this.nmi_transition=false;this.nmi_pending=false;this.irq_valid=false;this.irq_line=false;this.irq_transition=false;this.irq_pending=false;this.irq_lock=false;this.hdma_pending=false;this.wram_addr=0;this.joypad_strobe_latch=false;this.nmi_enabled=false;this.virq_enabled=false;this.hirq_enabled=false;this.auto_joypad_poll_enabled=false;this.pio=0;this.wrmpya=0;this.wrmpyb=0;this.wrdiva=0;this.wrdivb=0;this.htime=0;this.vtime=0;this.rom_speed=0;this.rddiv=0;this.rdmpy=0;this.joy1l=0 this.joy1h=0;this.joy2l=0 this.joy2h=0;this.joy3l=0 this.joy3h=0;this.joy4l=0 this.joy4h=0}SNESJS.CPU.QueueEvent={DramRefresh:0,HdmaRun:1};SNESJS.CPU.prototype.queue_event=function(a){switch(a){case SNESJS.CPU.QueueEvent.DramRefresh:return add_clocks(40);case SNESJS.CPU.QueueEvent.HdmaRun:return hdma_run()}}SNESJS.CPU.prototype.last_cycle=function(){if(this.status.irq_lock){this.status.irq_lock=false;return}if(this.status.nmi_transition){regs.wai=false;this.status.nmi_transition=false;this.status.nmi_pending=true}if(this.status.irq_transition||this.regs.irq){this.regs.wai=false;this.status.irq_transition=false;this.status.irq_pending=!this.regs.p.i}}SNESJS.CPU.prototype.add_clocks=function(a){if(this.status.hirq_enabled){if(this.status.virq_enabled){var b=this.snes.ppucounter.vcounter()*1364+hcounter();var c=this.status.vtime*1364+this.status.htime*4;var d=(system.region.i==REGION_NTSC?262:312)+field();if(b>c){c+=d*1364}var f=this.status.irq_valid;this.status.irq_valid=b<=c&&b+a>c;if(!f&&this.status.irq_valid){this.status.irq_line=true}}else{var c=this.status.htime*4;if(hcounter()>c){c+=1364}var f=this.status.irq_valid;this.status.irq_valid=hcounter()<=c&&hcounter()+a>c;if(!f&&this.status.irq_valid){this.status.irq_line=true}}if(this.status.irq_line){this.status.irq_transition=true}}else if(this.status.virq_enabled){var f=this.status.irq_valid;this.status.irq_valid=vcounter()==this.status.vtime;if(!f&&this.status.irq_valid){this.status.irq_line=true}if(this.status.irq_line){this.status.irq_transition=true}}else{this.status.irq_valid=false}this.status.tick(a);queue.tick(a);step(a)}SNESJS.CPU.prototype.scanline=function(){this.status.synchronize_smp();this.status.synchronize_ppu();this.status.synchronize_coprocessors();this.snes.system.scanline();if(vcounter()==0)hdma_init();queue.enqueue(534,SNESJS.CPU.QueueEvent.DramRefresh);if(vcounter()<=(ppu.overscan()==false?224:239)){queue.enqueue(1104+8,SNESJS.CPU.QueueEvent.HdmaRun)}var a=this.status.nmi_valid;this.status.nmi_valid=vcounter()>=(ppu.overscan()==false?225:240);if(!a&&this.status.nmi_valid){this.status.nmi_line=true;if(this.status.nmi_enabled){this.status.nmi_transition=true}}else if(a&&!this.status.nmi_valid){this.status.nmi_line=false}if(this.status.auto_joypad_poll_enabled&&vcounter()==(ppu.overscan()==false?227:242)){this.status.run_auto_joypad_poll()}}SNESJS.CPU.prototype.run_auto_joypad_poll=function(){this.snes.input.port1.latch(1);this.snes.input.port2.latch(1);this.snes.input.port1.latch(0);this.snes.input.port2.latch(0);var a=0,b=0,c=0,d=0;for(var f=0;f<16;f++){var e=this.snes.input.port1.data();var g=this.snes.input.port2.data();a|=(e&1)?(0x8000>>f):0;b|=(g&1)?(0x8000>>f):0;c|=(e&2)?(0x8000>>f):0;d|=(g&2)?(0x8000>>f):0}this.status.joy1l=a;this.status.joy1h=a>>8;this.status.joy2l=b;this.status.joy2h=b>>8;this.status.joy3l=c;this.status.joy3h=c>>8;this.status.joy4l=d;this.status.joy4h=d>>8}SNESJS.Bus=function(a){this.snes=a;this.reader=[];this.writer=[];this.lookup=[];this.target=[]}SNESJS.Bus.prototype.mirror=function(a,b){var c=0;if(b){var d=1<<23;while(a>=b){while(!(a&d))d>>=1;a-=d;if(b>d){b-=d;c+=d}d>>=1}c+=a}return c}SNESJS.Bus.prototype.map=function(a,b,c){var d=this.page[a>>8];d.access=b;d.offset=c-a}SNESJS.Bus.prototype.map=function(a,b,c,d,f,e,g,h,j){var n=idcount++;this.reader[n]=e;this.writer[n]=g;if(j==0){j=(c-b+1)*(f-d+1)}var o=0;for(var k=b;k<=c;k++){for(var l=d;l<=f;l++){var m=(k<<16)|l;if(a==SNESJS.Bus.MapMode.Linear){m=this.mirror(h+o++,j)}if(a==SNESJS.Bus.MapMode.Shadow){m=this.mirror(h+m,j)}this.lookup[(k<<16)|l]=n;this.target[(k<<16)|l]=m}}}SNESJS.Bus.bus_reader_dummy=function(a,b){return a.regs.mdr}SNESJS.Bus.bus_writer_dummy=function(a,b,c){}SNESJS.Bus.prototype.map_reset=function(){for(var a=0;a<0x100;a++){this.reader[a]=SNESJS.Bus.bus_reader_dummy}for(var a=0;a<0x100;a++){this.writer[a]=SNESJS.Bus.bus_writer_dummy}idcount=0;this.map(SNESJS.Bus.MapMode.Direct,0x00,0xff,0x0000,0xffff,this.reader,this.writer)}SNESJS.Bus.prototype.map_xml=function(){for(var a=0;a<this.snes.cartridge.mapping.length;a++){var b=this.snes.cartridge.mapping[a];map(b.mode.i,b.banklo,b.bankhi,b.addrlo,b.addrhi,b.read,b.write,b.offset,b.size)}}SNESJS.Bus.prototype.read=function(a){return this.reader[this.lookup[a]](this.target[a])}SNESJS.Bus.prototype.write=function(a,b){return writer[this.lookup[a]](this.target[a],this.data)}SNESJS.Bus.MapMode={Direct:0,Linear:1,Shadow:2}function uclip24(a){return a&0xffffff}function uclip16(a){return a&0xffff}function uclip8(a){return a&0xff}function getFunctionByName(a){var b=window;var c=Array.prototype.slice.call(arguments).splice(2);var d=a.split(".");var f=d.pop();for(var e=0;e<d.length;e++){b=b[d[e]]}return b[f]}